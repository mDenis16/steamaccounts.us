
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@model csgo.postModels.addAccount
@{
    ViewData["Title"] = "Home Page";
    ViewBag.logged = false;
    csgo.usersManager.userData account = null;
    if (HttpContextAccessor.HttpContext.Request.Cookies["sessionid"] != null)
    {
        account = csgo.usersManager.getUserData(HttpContextAccessor.HttpContext.Request).Result;
        if (account != null)
        {
            ViewBag.account = account;
            ViewBag.logged = true;
            if (account.seller)
            csgo.Controllers.adminController.tokenAccess.createToken(HttpContextAccessor.HttpContext.Request, csgo.Controllers.adminController.tokenType.generateemail);
        }
       
    }
}
@functions{
    public string GetAntiXsrfRequestToken()
    {
        return Xsrf.GetAndStoreTokens(Context).RequestToken;
    }
}
<style>
    .dropzone {
        border: 4px dashed #ccc;
        height: 100%;
        position: relative;
        margin-right: auto;
        margin-left: auto;
        max-width: 100%;
    }

    .info {
        margin-top: 11%;
    }

    .dropzone p {
        /*height: 100%;*/
        /*line-height: 200px;*/
        margin: 0%;
        text-align: center;
        width: 100%
    }

    .input {
        height: 100%;
        left: 0;
        outline: 0;
        opacity: 0;
        position: absolute;
        top: 0;
        width: 100%
    }
</style>
<style>
    .dropzone {
        border: 4px dashed #ccc;
        height: 100%;
        position: relative;
        margin-right: auto;
        margin-left: auto;
        max-width: 100%;
    }

    .info {
        margin-top: 11%;
    }

    .dropzone p {
        /*height: 100%;*/
        /*line-height: 200px;*/
        margin: 0%;
        text-align: center;
        width: 100%
    }

    .input {
        height: 100%;
        left: 0;
        outline: 0;
        opacity: 0;
        position: absolute;
        top: 0;
        width: 100%
    }
</style>
<div class="modal fade" id="processingModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog modal-dialog-centered modal-notify modal-success" role="document">
        <!--Content-->
        <div class="modal-content">
            <!--Header-->
            <div class="modal-header elegant-color-dark">
                <p class="heading lead">Checking your account</p>


            </div>

            <!--Body-->
            <div class="modal-body">
                <div class="d-flex justify-content-center">
                    <div class="preloader-wrapper big active">
                        <div class="spinner-layer spinner-blue-only">
                            <div class="circle-clipper left">
                                <div class="circle"></div>
                            </div>
                            <div class="gap-patch">
                                <div class="circle"></div>
                            </div>
                            <div class="circle-clipper right">
                                <div class="circle"></div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="d-flex justify-content-center text-center align-middle pt-3">
                    <span class="align-middle">It can takes 5-10 seconds to process the request.</span>
                </div>



            </div>





        </div>
        <!--/.Content-->
    </div>
</div>


<div class="modal fade" id="changeEmailModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog modal-dialog-centered modal-notify modal-success" role="document">
        <!--Content-->
        <div class="modal-content">
            <!--Header-->
            <div class="modal-header elegant-color-dark">
                <p class="heading lead" id="modalTitleEmail">Generating your email</p>


            </div>

            <!--Body-->
            <div class="modal-body">
                <div class="d-flex justify-content-center" id="emailBody">
                    <div class="preloader-wrapper big active">
                        <div class="spinner-layer spinner-blue-only">
                            <div class="circle-clipper left">
                                <div class="circle"></div>
                            </div>
                            <div class="gap-patch">
                                <div class="circle"></div>
                            </div>
                            <div class="circle-clipper right">
                                <div class="circle"></div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="d-flex justify-content-center text-center align-middle pt-3">
                    <span class="align-middle">This can takes from 30 seconds to 2 minutes.</span>
                </div>



            </div>





        </div>
        <!--/.Content-->
    </div>
</div>
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" data-backdrop="false"
     aria-labelledby="exampleModalCenterTitle" aria-hidden="true">

    <!-- Add .modal-dialog-centered to .modal-dialog to vertically center the modal -->
    <div class="modal-dialog modal-dialog-centered" role="document">


        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Uploading...</h5>

            </div>
            <div class="modal-body text-center">
                <div class="preloader-wrapper active">
                    <div class="spinner-layer spinner-blue-only">
                        <div class="circle-clipper left">
                            <div class="circle"></div>
                        </div>
                        <div class="gap-patch">
                            <div class="circle"></div>
                        </div>
                        <div class="circle-clipper right">
                            <div class="circle"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<div class="modal fade" id="checkCodeModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-notify modal-success" role="document">
        <!--Content-->
        <div class="modal-content">
            <!--Header-->
            <div class="modal-header elegant-color-dark">
                <p class="heading lead" id="modalTitleEmail">Your code is</p>


            </div>

            <!--Body-->
            <div class="modal-body">

                <div class="d-flex justify-content-center text-center align-middle pt-3">
                    <span class="align-middle" id="steamCode"></span>
                </div>



            </div>





        </div>
        <!--/.Content-->
    </div>
</div>
<div class="modal fade" id="selectAccountType"  data-backdrop="false" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
     aria-hidden="true">

    <!-- Add .modal-dialog-centered to .modal-dialog to vertically center the modal -->
    <div class="modal-dialog modal-dialog-centered " role="document">


        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Select account type</h5>
              
            </div>
            <div class="modal-body row">
                <img src="https://www.freeiconspng.com/uploads/silver-csgo-icon-13.png" style="width: 128px; height: 128px;" class="rounded mx-auto d-block" id="csgoAccount">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c6/Breezeicons-apps-48-steam.svg/1200px-Breezeicons-apps-48-steam.svg.png" class="rounded mx-auto d-block" id="steamAccount" style="height: 128px; width: 128px">
            </div>
          
        </div>
    </div>
</div>
@{ 
   
    if (account != null && account.seller)
    {
<main class="mt-5 pt-lg-5">
    <div class="container">
        <main role="main" class="row ">



            <div class="col-md-5 card card-ecommerce mr-5">

                <div class="card-body">

                    <h4 class="card-title font-weight-bold mb-2">Account login</h4>
                    <div class="md-form">
                        <input class="form-control" data-val="true" data-val-required="The username field is required."
                               id="username" name="username" type="text" value="">
                        <label for="username">Username</label>
                    </div>
                    <div class="md-form">
                        <input class="form-control" data-val="true" data-val-required="The username field is required."
                               id="password" name="password" type="text" value="">
                        <label for="password">Password</label>
                    </div>
                    <p class="note note-danger"><strong class="text-warning">Warning! </strong> Disable your steamguard, 2fa and your mobile number.</p>

                </div>

            </div>

            <div class="col-md-5 card card-ecommerce ml-5">

                <div class="card-body" id="changeContent">

                    <h4 class="card-title font-weight-bold mb-2 ">Account informations</h4>
                    <select class="mdb-select md-form" id="rank" searchable="Search your rank">
                        <option>Unranked</option>
                        <option>Silver 1</option>
                        <option>Silver 2</option>
                        <option>Silver 3</option>
                        <option>Silver 4</option>
                        <option>Silver Elite</option>
                        <option>Silver Elite Master</option>
                        <option>Gold Nova 1</option>
                        <option>Gold Nova 2</option>
                        <option>Gold Nova 3</option>
                        <option>Gold Nova Master</option>
                        <option>Master Guardian 1</option>
                        <option>Master Guardian 2</option>
                        <option>Master Guardian Elite</option>
                        <option>Distinguished Master Guardian</option>
                        <option>Legendary Eagle</option>
                        <option>Legendary Eagle Master</option>
                        <option>Supreme Master</option>
                        <option>Global Elite</option>
                    </select>
                    <div class="row">
                        <!-- Last name -->


                        <div class="col">
                            <!-- Last name -->
                            <div class="md-form">
                                <div class="switch">
                                    <label>


                                        <input data-val="true" data-val-range="The field Is Active must be checked."
                                               data-val-range-max="True" data-val-range-min="False"
                                               data-val-required="The prime field is required." id="prime" name="prime" type="checkbox"
                                               value="true">
                                        <span class="lever"></span>Prime
                                    </label>
                                </div>

                            </div>
                        </div>
                        <div class="col">
                            <!-- Last name -->
                            <div class="md-form">
                                <input class="form-control" data-val="true" data-val-required="The hours field is required."
                                       id="hours" name="hours" type="number" value="">
                                <label for="hours" class="active">Hours</label>
                            </div>
                        </div>
                        <div class="col">
                            <!-- Last name -->
                            <div class="md-form">

                                <input class="form-control" data-val="true" data-val-required="The wins field is required." id="wins"
                                       name="wins" type="number" value="">
                                <label for="wins">Wins</label>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="col-md-11 card card-ecommerce mt-5">

                <div class="card-body container">

                    <h4 class="card-title font-weight-bold mb-2 ">Description</h4>



                    <div class="row">
                        <div class="col-sm">
                            <div class="md-form">
                                <textarea id="description" class="md-textarea form-control" rows="6"></textarea>
                                <label for="description">Write your description...</label>
                            </div>
                        </div>
                        <div class="col-sm">
                            <div class="dropzone" imageurl="none">
                                <div class="info">

                                </div>
                                <input type="file" class="input" accept="image/*">
                            </div>
                        </div>

                    </div>

                </div>

            </div>
            <div class="col-md-5 card card-ecommerce mr-5 mt-5 mb-5">
                <div class="card-body">
                    <h4 class="card-title font-weight-bold mb-2">Change your steam account email to this</h4>

                    <div class="md-form mt-5">
                        <button type="button" id="changeEmail" class="btn btn-info btn-rounded btn-block waves-effect waves-light mt-3">CHANGE EMAIL</button>
                    </div>
                    <a type="button" class="float-left text-primary" onclick="window.open('https://temp-mail.org/ro/change')">How to change email?</a>
                </div>

            </div>
            <div class="col-md-5 card card-ecommerce ml-5 mt-5 mb-5">

                <div class="card-body">

                    <h4 class="card-title font-weight-bold mb-2 ">Finish</h4>

                    <div class="row">
                        <!-- Last name -->
                        <div class="col">
                            <!-- Last name -->
                            <div class="md-form" id="asd">
                                <input class="form-control" data-val="true" data-val-required="The price field is required."
                                       id="price" name="price" type="number" value="">

                            </div>
                            <label for="asd" id="receiveMoney">You will receive 0.0 <i class="fas fa-euro-sign"></i>.</label>

                        </div>

                    </div>
                    <button type="button" class="btn btn-block btn-success btn-rounded mt-5" id="submitBtn">Sell account</button>
                </div>

            </div>
        </main>
    </div>
</main>
<script type="text/javascript" src="~/js/imgur.js"></script>
<script type="text/javascript">
    var type = 0;
   
    function isValidEmailAddress(emailAddress) {
        var pattern = new RegExp(/^(("[\w-+\s]+")|([\w-+]+(?:\.[\w-+]+)*)|("[\w-+\s]+")([\w-+]+(?:\.[\w-+]+)*))(@@((?:[\w-+]+\.)*\w[\w-+]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$)|(@@\[?((25[0-5]\.|2[0-4][\d]\.|1[\d]{2}\.|[\d]{1,2}\.))((25[0-5]|2[0-4][\d]|1[\d]{2}|[\d]{1,2})\.){2}(25[0-5]|2[0-4][\d]|1[\d]{2}|[\d]{1,2})\]?$)/i);
        return pattern.test(emailAddress);
    };
    function imageExists(image_url) {

        var http = new XMLHttpRequest();

        http.open('HEAD', image_url, false);
        http.send();

        return http.status != 404;

    }
    var email = "none";
    $(document).ready(function () {
        var body = $(".mt-5 ,pt-lg-5");
       $("#selectAccountType").modal('show');
        $("#csgoAccount").click(function () {
            $("#selectAccountType").modal('hide');
            type = 0;
            body.fadeIn(400, function () { });
        });
        $("#steamAccount").click(function () {
            $("#selectAccountType").modal('hide');
            body.fadeIn(400, function () { });
            type = 1;
            $("#changeContent").html(`
<div class="card-body">
<h4 class="card-title font-weight-bold mb-2 ">Account informations</h4>
<div class="md-form">
<input class="form-control" data-val="true" data-val-required="The username field is required." id="title" name="username" type="text" value="">
<label for="title">Enter your title</label>
</div>
<div class="md-form">
<textarea id="gamesList" class="md-textarea form-control" rows="6"></textarea>
<label for="description" class="">Enter games line by line </label>
</div>
</div>`);
            $(".mt-5 ,pt-lg-5").fadeIn(400, function () { })
        });
        
        $('.mdb-select').materialSelect();
        var feedback = function (res) {
            if (res.success === true) {
                var get_link = res.data.link.replace(/^http:\/\//i, 'https://');
                $(".dropzone").attr("style", `background-image: url(${get_link});
          background-size:     cover;                      /* <------ */
    background-repeat:   no-repeat;
    background-position: center center;
    `)
                console.log(get_link);
                $(".dropzone").attr("imageurl", get_link);
                $("#exampleModalCenter").modal('hide');
            }
        };

        new Imgur({
            clientid: '4409588f10776f7', //You can change this ClientID
            callback: feedback
        });
        $("#price").on('input', function () {
            var price_val = $("#price").val(); var fee = 9.00;
            if (price_val > 15.00)
                fee = 10.00;

            if (price_val > 30.00)
              fee = 11.00;
            
            if (price_val > 45.00)
               fee = 13.00;
        
            var price = ($("#price").val() - ((fee / 100.00) * $("#price").val()).toFixed(2)).toFixed(2);
            $("#receiveMoney").html(`You will receive ${price} <i class="fas fa-euro-sign"></i>.`);
         });
        $('body').on('click', '.checkCode', function () {

            $.ajax({
                url: "/marketPlace/readEmailCode",
                type: 'GET',
                data: {},
                dataType: 'json',
                success: function (result) {

                    if (!result.success) {
                        toastr.error(result.error);
                    } else {
                        $("#checkCodeModal").modal('show');
                        console.log(result.code);
                        $("#steamCode").html(result.code);
                    }


                },
                error: function () {

                }
            });
        });
        $('body').on('click', '.closeCode', function () {

            $("#changeEmailModal").modal('hide');

        });


        $("#changeEmail").click(function (event)  {
            $("#changeEmailModal").modal('show');
            setTimeout(() => {

               $.ajax({
                url: "/marketPlace/requestEmailService",
                type: 'GET',
                   data: {
                       username: $("#username").val(),
                       password: $("#password").val()},
                dataType: 'json',
                success: function (result) {

                    if (!result.success) {
                        toastr.error(result.message);
                        email == "none";
                    } else {
                        email = result.email;
                        $("#emailBody").html(`

<div class="md-form row mr-1 ml-1">
                        <input class="form-control" data-val="true" data-val-required="The username field is required." id="email" name="email" type="text" value="${result.email}" disabled="">

                        <div class="md-form"></div>

                        <button type="button" class="btn btn-block btn-danger btn-rounded closeCode">Close</button><button type="button" class="btn btn-block btn-success btn-rounded checkCode">Check code</button>
</div>



                          `);
                        $("#modalTitleEmail").text("Change your email to this email");

                        setTimeout(() => {
                            $(".checkCode").prop("disabled", false);
                        }, 5000);
                    }


                },
                error: function () {
                    $("#processingModal").modal('hide');
                }
            });
            }, 3000);
        });
        $("#submitBtn").click(function (event) {

            if (!$("#username").val()) {
                toastr.error('Username can`t be empty.');
                return;
            }

            if (!$("#password").val()) {
                toastr.error('Password can`t be empty.');
                return;
            }
            if (type == 0) {
                if (!$("#hours").val()) {
                    toastr.error('Hours can`t be empty.');
                    return;
                }

                if ($("#hours").val() < 0) {
                    toastr.error('Hours can`t under 0.');
                    return;
                }
                if ($("#hours").val() > 0 && !$.isNumeric($("#hours").val())) {
                    toastr.error('Hours needs to be numer');
                    return;
                }
                if (!$("#wins").val()) {
                    toastr.error('Wins can`t be empty.');
                    return;
                }
               
                if ($("#wins").val() < 0) {
                    toastr.error('Wins can`t under 0.');
                    return;
                }


                if ($("#wins").val() > 0 && !$.isNumeric($("#wins").val())) {
                    toastr.error('Wins needs to be numer');
                    return;
                }
            }
            if (email == "none") {
                toastr.error('You didnt setup the email.');
                return;
            }

            $("#processingModal").modal('show');

            $.ajax({
                url: "/marketPlace/addAccountApi",
                type: 'POST',
                data: {
                    receive: JSON.stringify(
                        {
                            username: $("#username").val(),
                            password: $("#password").val(),
                            email: email,
                            emailPassword: "none",
                            price: $("#price").val(),
                            rank: $("#rank").val(),
                            title: $("#title").val(),
                            wins: $("#wins").val(),
                            prime: $("#prime").is(":checked") ? 1 : 0,
                            hours: $("#hours").val(),
                            rank: $("#rank").val(),
                            imageLink: $(".dropzone").attr('imageurl'),
                            description: $('#description').val(),
                            gameList: $("#gamesList").val(),
                            title: $("#title").val(),
                            type: type

                        })
                },
                dataType: 'json',
                success: function (result) {
                    $("#processingModal").modal('hide');
                   // console.log(`recieved result ${result}`);
                    if (!result.success) {
                        toastr.error(result.message);
                        
                    } else {
                        toastr.success(result.message);
                              window.location.replace("@Url.Action("index", "home")");
                    }


                },
                error: function () {
                    $("#processingModal").modal('hide');
                }
            });
            setTimeout(() => {
                $("#processingModal").modal('hide');
            }, 1000);


        });

    });


</script>
        }
    }